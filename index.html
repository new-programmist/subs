<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>@ゆっくりhoneboneの登録者グラフ</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { border: 1px solid #ccc; margin-top: 10px; }
    #unitSelector { margin: 10px; }
  </style>
</head>
<body>
  <div id="unitSelector">
    <label><input type="radio" name="unit" value="minute" checked> 分</label>
    <label><input type="radio" name="unit" value="hour"> 時</label>
    <label><input type="radio" name="unit" value="day"> 日</label>
  </div>
  <canvas id="graphCanvas" width="800" height="400"></canvas>
  <div id="fileInputContainer" style="display:none;">
    <input type="file" id="fileInput" accept=".txt">
  </div>

  <script>
    const canvas = document.getElementById("graphCanvas");
    const ctx = canvas.getContext("2d");
    const fileInputContainer = document.getElementById("fileInputContainer");
    const fileInput = document.getElementById("fileInput");
    let parsedData = [];

    function parseLog(text) {
      const lines = text.trim().split("\n");
      const data = lines.map(line => {
        const match = line.match(/^([\d/ :]+)\s+(.+?)\s+(\d+)\s+subscribers$/);
        if (!match) return null;
        const [, timestamp, , subs] = match;
        return {
          time: new Date(timestamp),
          subs: parseInt(subs, 10)
        };
      }).filter(x => x !== null);
      return data;
    }

    function drawLineGraph(data, unit = "minute") {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (data.length < 2) return;

      const margin = 40;
      const times = data.map(d => d.time.getTime());
      const subs = data.map(d => d.subs);
      const minTime = Math.min(...times);
      const maxTime = Math.max(...times);
      const minSubs = Math.min(...subs);
      const maxSubs = Math.max(...subs);

      // 座標変換
      function getX(time) {
        return margin + ((time - minTime) / (maxTime - minTime)) * (canvas.width - 2 * margin);
      }
      function getY(sub) {
        return canvas.height - margin - ((sub - minSubs) / (maxSubs - minSubs)) * (canvas.height - 2 * margin);
      }

      // 軸
      ctx.strokeStyle = "#000";
      ctx.beginPath();
      ctx.moveTo(margin, margin);
      ctx.lineTo(margin, canvas.height - margin);
      ctx.lineTo(canvas.width - margin, canvas.height - margin);
      ctx.stroke();

      // 線
      ctx.beginPath();
      ctx.strokeStyle = "#0077cc";
      ctx.lineWidth = 2;
      data.forEach((d, i) => {
        const x = getX(d.time.getTime());
        const y = getY(d.subs);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // 平均増加速度の表示
      const first = data[0];
      const last = data[data.length - 1];
      const subsDiff = last.subs - first.subs;
      const msDiff = last.time - first.time;
      let unitLabel = "", rate = 0;

      if (msDiff > 0) {
        if (unit === "minute") {
          rate = subsDiff / (msDiff / (1000 * 60));
          unitLabel = "人/分";
        } else if (unit === "hour") {
          rate = subsDiff / (msDiff / (1000 * 60 * 60));
          unitLabel = "人/時";
        } else if (unit === "day") {
          rate = subsDiff / (msDiff / (1000 * 60 * 60 * 24));
          unitLabel = "人/日";
        }
      }

      ctx.fillStyle = "black";
      ctx.textAlign = "right";
      ctx.textBaseline = "top";
      ctx.font = "16px sans-serif";
      ctx.fillText(
        `平均増加速度: ${rate.toFixed(2)} ${unitLabel}`,
        canvas.width - 10,
        10
      );
    }

    function parseAndDraw(text) {
      parsedData = parseLog(text);
      const selectedUnit = document.querySelector('input[name="unit"]:checked').value;
      drawLineGraph(parsedData, selectedUnit);
    }

    document.querySelectorAll('input[name="unit"]').forEach(input => {
      input.addEventListener('change', () => {
        if (parsedData.length > 0) {
          drawLineGraph(parsedData, input.value);
        }
      });
    });

    // fetch (キャッシュバスター付き)
    fetch('subs_log.txt?' + Date.now())
      .then(res => {
        if (!res.ok) throw new Error("読み込み失敗");
        return res.text();
      })
      .then(parseAndDraw)
      .catch(err => {
        console.warn("fetch失敗:", err);
        fileInputContainer.style.display = "block";
      });

    fileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => parseAndDraw(e.target.result);
      reader.readAsText(file);
    });
  </script>
</body>
</html>

