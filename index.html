<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>@ゆっくりhoneboneの登録者グラフ</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { border: 1px solid #ccc; margin-top: 10px; }
    #unitSelector { margin: 10px; }
    #avgRateDisplay {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="unitSelector">
    <label><input type="radio" name="unit" value="minute" checked> 分</label>
    <label><input type="radio" name="unit" value="hour"> 時</label>
    <label><input type="radio" name="unit" value="day"> 日</label>
  </div>
  <canvas id="graphCanvas" width="800" height="400"></canvas>
  <div id="avgRateDisplay">平均増加速度: -</div>
  <div id="fileInputContainer" style="display:none;">
    <input type="file" id="fileInput" accept=".txt">
  </div>

  <script>
    const canvas = document.getElementById("graphCanvas");
    const ctx = canvas.getContext("2d");
    const unitRadios = document.querySelectorAll("input[name='unit']");
    const avgRateDisplay = document.getElementById("avgRateDisplay");
    let globalData = [];

    unitRadios.forEach(radio => {
      radio.addEventListener("change", () => updateAvgRate());
    });

    function parseAndDraw(text) {
      const lines = text.trim().split("\n");
      const data = lines.map(line => {
        const match = line.match(/^(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}) .*? (\d+) subscribers$/);
        if (!match) return null;
        return {
          time: new Date(match[1]),
          subs: parseInt(match[2], 10)
        };
      }).filter(Boolean);

      if (data.length > 1) {
        globalData = data;
        drawLineGraph(data);
        updateAvgRate();
      }
    }

    function drawLineGraph(data) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const padding = 40;
      const points = data.map(d => ({ x: d.time.getTime(), y: d.subs }));
      const minX = Math.min(...points.map(p => p.x));
      const maxX = Math.max(...points.map(p => p.x));
      const minY = Math.min(...points.map(p => p.y));
      const maxY = Math.max(...points.map(p => p.y));

      function toCanvasX(x) {
        return padding + (x - minX) / (maxX - minX) * (canvas.width - 2 * padding);
      }
      function toCanvasY(y) {
        return canvas.height - padding - (y - minY) / (maxY - minY) * (canvas.height - 2 * padding);
      }

      // 軸
      ctx.strokeStyle = "#888";
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();

      // Y軸目盛
      ctx.fillStyle = "black";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      const steps = 6;
      for (let i = 0; i <= steps; i++) {
        const y = minY + (maxY - minY) * i / steps;
        const cy = toCanvasY(y);
        ctx.fillText(Math.round(y), padding - 5, cy);
        ctx.strokeStyle = "#eee";
        ctx.beginPath();
        ctx.moveTo(padding, cy);
        ctx.lineTo(canvas.width - padding, cy);
        ctx.stroke();
      }

      // X軸目盛
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for (let i = 0; i <= steps; i++) {
        const x = minX + (maxX - minX) * i / steps;
        const cx = toCanvasX(x);
        const date = new Date(x);
        const label = date.toLocaleTimeString([], {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });
        ctx.fillText(label, cx, canvas.height - padding + 5);
        ctx.strokeStyle = "#eee";
        ctx.beginPath();
        ctx.moveTo(cx, padding);
        ctx.lineTo(cx, canvas.height - padding);
        ctx.stroke();
      }

      // 折れ線と点
      ctx.strokeStyle = "blue";
      ctx.beginPath();
      data.forEach((d, i) => {
        const cx = toCanvasX(d.time.getTime());
        const cy = toCanvasY(d.subs);
        if (i === 0) ctx.moveTo(cx, cy);
        else ctx.lineTo(cx, cy);
      });
      ctx.stroke();

      ctx.fillStyle = "red";
      data.forEach(d => {
        const cx = toCanvasX(d.time.getTime());
        const cy = toCanvasY(d.subs);
        ctx.beginPath();
        ctx.arc(cx, cy, 3, 0, 2 * Math.PI);
        ctx.fill();
      });
    }

    function updateAvgRate() {
      const data = globalData;
      if (data.length < 2) {
        avgRateDisplay.textContent = "平均増加速度: N/A";
        return;
      }

      const last = data[data.length - 1];
      let first = data.length > 15 ? data[data.length - 15] : data[0];
      const subsDiff = last.subs - first.subs;
      const timeDiffMin = (last.time - first.time) / 60000;

      const unit = document.querySelector("input[name='unit']:checked").value;
      let unitName = "分", factor = 1;
      if (unit === "hour") { unitName = "時"; factor = 60; }
      else if (unit === "day") { unitName = "日"; factor = 1440; }

      const avgRate = timeDiffMin > 0 ? (subsDiff / timeDiffMin * factor).toFixed(2) : "N/A";
      avgRateDisplay.textContent = `平均増加速度: ${avgRate} 人/${unitName}`;
    }

    // 読み込み処理
    fetch('subs_log.txt', { cache: 'no-store' })
      .then(r => r.ok ? r.text() : Promise.reject())
      .then(parseAndDraw)
      .catch(() => {
        document.getElementById("fileInputContainer").style.display = "block";
        document.getElementById("fileInput").addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = () => parseAndDraw(reader.result);
            reader.readAsText(file);
          }
        });
      });
  </script>
</body>
</html>

