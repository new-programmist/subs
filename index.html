<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>登録者数 折れ線グラフ</title>
<style>
  canvas { border:1px solid #ccc; }
</style>
</head>
<body>
<h1>登録者数 折れ線グラフ</h1>
<canvas id="chart" width="900" height="400"></canvas>
<script>
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");

fetch('subs_log.txt')
  .then(res => {
    if (!res.ok) throw new Error("ファイル読み込み失敗");
    return res.text();
  })
  .then(text => {
    const lines = text.split(/\r?\n/);
    const data = [];

    for (const line of lines) {
      if (!line.trim()) continue;
      const match = line.match(/^(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}) .+? (\d+) subscribers$/);
      if (!match) continue;

      const timeStr = match[1];
      const subs = parseInt(match[2], 10);
      const time = new Date(timeStr.replace(/\//g, "-"));

      data.push({ time, subs });
    }
    if (data.length === 0) throw new Error("データがありません");

    drawLineGraph(data);
  })
  .catch(e => {
    alert("エラー: " + e.message);
  });

function drawLineGraph(data) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  data.sort((a,b) => a.time - b.time);

  const margin = 50;
  const w = canvas.width - margin * 2;
  const h = canvas.height - margin * 2;

  // Y軸の範囲
  const subsMin = Math.min(...data.map(d => d.subs));
  const subsMax = Math.max(...data.map(d => d.subs));

  // 軸描画
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(margin, margin);
  ctx.lineTo(margin, margin + h);
  ctx.lineTo(margin + w, margin + h);
  ctx.stroke();

  // Y軸ラベル（5分割）
  ctx.fillStyle = "#000";
  ctx.textAlign = "right";
  ctx.textBaseline = "middle";
  for(let i=0; i<=5; i++){
    const y = margin + h - (h / 5) * i;
    const val = Math.round(subsMin + (subsMax - subsMin) / 5 * i);
    ctx.fillText(val.toString(), margin - 5, y);
    ctx.beginPath();
    ctx.moveTo(margin - 3, y);
    ctx.lineTo(margin, y);
    ctx.stroke();
  }

  // X軸ラベル（6個くらい）
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  const step = Math.max(1, Math.floor(data.length / 6));
  for(let i=0; i<data.length; i+=step){
    const d = data[i];
    const x = margin + ((d.time.getTime() - data[0].time.getTime()) / (data[data.length-1].time.getTime() - data[0].time.getTime())) * w;
    const label = `${d.time.getHours().toString().padStart(2,'0')}:${d.time.getMinutes().toString().padStart(2,'0')}`;
    ctx.fillText(label, x, margin + h + 5);
    ctx.beginPath();
    ctx.moveTo(x, margin + h);
    ctx.lineTo(x, margin + h + 3);
    ctx.stroke();
  }

  // 折れ線の描画
  ctx.strokeStyle = "blue";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0; i<data.length; i++){
    const d = data[i];
    const x = margin + ((d.time.getTime() - data[0].time.getTime()) / (data[data.length-1].time.getTime() - data[0].time.getTime())) * w;
    const y = margin + h - ((d.subs - subsMin) / (subsMax - subsMin)) * h;
    if(i === 0){
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }

    // データポイントを赤丸で表示
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.stroke();
}
</script>
</body>
</html>

